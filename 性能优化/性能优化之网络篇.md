## 性能优化之网络篇

#### 1.网络速度的指标和测量

网络请求的步骤 

| 客户端 |           <———>           | 服务端 |
| :----: | :-----------------------: | :----: |
|        |        DNS查询——>         |        |
|        | CDN/边缘服务器解决方案——> |        |
|        |    SSL握手然后请求——>     |        |
|        |          <——响应          |        |



##### 1.1.1DNS查找时间

> 最佳实践：减少 DNS 查询时间所产生的延迟
>
> - 在应用启动时不需要连接所有的域名，可能只需要身份管理和初始画面所需的数据。对 于后续的子域名，尝试更早地进行 DNS 解析，也被称为 DNS 预先下载 
>
>   如果子域名和主机在控制范围内，你可以配置一个预设的 URL，不返回任何数据，只 返回 HTTP 204 的状态码，然后提前对该 URL 发起连接。 
>
>   第二个方法是使用 gethostbyname 执行一个明确的 DNS 查找。然而，针对不同的协议， 主机可能会解析至不同的 IP，例如，HTTP 请求可能会解析至一个地址，而 HTTPS 会 解析至另一个地址。虽然不是很常见，但第 7 层的路由可以根据实际的请求解析 IP 地 址，例如，图像是一个地址，视频是另外一个地址。鉴于这些因素，在连接之前解析 DNS 经常是无用的，对主机进行伪连接会更有效 
>
> - 最小化应用使用的专有域名的数量  
>
>   - 按照路由的一般工作方式，多个域名是不可避免的。 
>
>     最好是能做到以下几点: 
>
>     (1) 身份管理(登录、注销、配置文件) (2) 数据服务(API 端点)
>      (3) CDN(图片和其他静态人工产品) 
>
>     有可能需要其他域名(例如，用于提供视频、上传检测数据、具体的子数据服务、广告 投放，甚至是国家特定的全球本地化)。如果子域名数量上升至两位数，那么势必会引 发担忧。 
>
>     

##### 1.1.2SSL握手时间

SSL握手的主要步骤

1. 客户端问候消息 >

2. 服务端问候消息<

3. 服务器证书<

4. 共享秘钥>

5. 共享秘钥回复<

6. 客户端结束>

7. 服务端结束<

   > 最佳实践 ：
   >
   > 1. 最大程度地减少应用发起的连接数 减少和服务端链接的数量 
   > 2. 请求结束后不要关闭 HTTP/S 连接，添加请求头Connection：keep-alive，这样可以复用链接
   > 3.  使用域分片。解析出来是同一个IP就使用同一个证书就可以  了 

##### 1.1.3网络类型 

> 最佳实践：
>
> 1. 设计时考虑不同的网络可用性
> 2. 出现失败时，在随机的、以指数增长的延迟后进行重试
> 3. 设立强制刷新之间的最短时间 。  当用户明确要求刷新时，不要立即发出请求。相反，检
>    查是否已经存在一个请求，或当前请求与上次请求的时间间隔是否小于阈值。如果满足
>    上述条件，则不要发送此次请求
> 4. 使用可到达性库发现网络状态的变化
> 5. 不要缓存网络状态
> 6. 基于网络类型下载内容
> 7. 乐观地预先下载
> 8. 如果适用，当网络可用时，支持同步的离线存储(无网络时候的评论点赞)

##### 1.1.4 网络延迟

延迟是指从服务器请求资源时，在网络传输上花费的额外时间，

网络延迟可以通过使用请求过程中花费的总时间减去服务器上花费的时间

> 下列数据也是需要进行检测的 ：
>
> - 连接超时 
>   跟踪连接次数是非常重要的，根据网络情况的好坏来进行处理
> - 响应超时 
>   捕获连接成功但响应超时的数量，有助于根据地理位置和日期，来规划数据中心的容量
> - 载荷大小
>   用ProtoBuf，Json等来减少数据流的传输，并且降低网络操作速度的峰值 



##### 1.1.5 网络Api 

在IOS7.0以前用的`NSURLConnection` 在之后用的 是 `NSURLSession` 

使用`NSURLSession`  的优点  

1. NSURLSession 对于放入其中的相关请求而言是一个可配置的容器。例如，对服务器的所 有请求都可配置成始终包含访问令牌。 

2. 你可以得到后台联网的所有好处。这有助于提高电池寿命、支持 UIKit 的多任务、使用 与过程传输相同的委托模型 

3. 任何网络任务都可以暂停、停止并重新启动。与 NSURLConnection 不同，此处并不需要 是 NSOperation 的子类。 

4. 你可以继承 NSURLSession 来配置会话，以便在每个会话的基础上使用专用存储(缓存、 cookie jar 等)。 

5. 当使用 NSURLConnection 时，如果遇到了身份验证问题，问题会在任何一个请求中返回， 你无法明确知道哪个请求遇到了这个问题。使用 NSURLSession，委托会处理身份验证 

6. NSURLConnection 有一些基于块的异步方法，但委托不能使用它们。当发起一个请求时， 

   要么成功，要么失败，即使它需要身份验证 

7. 使用 NSURLSession，你可以采取一种混合的方法，这也就是说，你可以使用基于块的异 

   步方法，还可以设置委托以处理身份验证 

#### 1.2 网络部署

##### 1.2.1 服务器

服务器配置的最佳实践 

1. 使用多个数据中心，让服务器在地理上分散开来， 
2. 使用 CDN 提供静态内容，如图像、JavaScript、CSS、字体等 
3. 使用接近的边缘服务器(http://serverfault.com/a/67489)来提供动态内容 
4. 避免使用多个域名(DNS 查询时间可能会很长，这会降低用户体验)。 

> Tips：第二和第四是互斥的，需要权衡，当使用DNS时，要最大的限度减少DNS查找时间

##### 1.2.2 传输的数据格式

- 使用数据压缩。当传送 JSON 或 XML 这样的文本内容时，这一点尤为重要。 NSURLRequest 会自动给头部添加 Accept-Encoding:gzip、deflate 
- 选择正确的数据格式。不用多想，JSON 和 XML 这样冗长、人类可读的格式是资源密 集型的——序列化、传输、反序列化会比使用自定义制作的、二进制的、机器友好的格 式更耗费时间 

> Tips：为什么大多数公司都是使用Json或者XML呢
>
> 唯一的原因 就是 web 服务 /API 是 为 Web 编写的，并且用于移动端 
>
> 另一个更好的选择就是 Protocol Buffers
>
>  

